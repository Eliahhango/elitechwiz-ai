<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect to WhatsApp - EliTechWiz AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #25D366;
            --secondary-color: #128C7E;
            --accent-color: #075E54;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #198754;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }

        .container-fluid {
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1200px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="50" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="30" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .whatsapp-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .connection-methods {
            padding: 40px;
        }

        .method-card {
            background: var(--light-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid transparent;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .method-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(37, 211, 102, 0.2);
        }

        .method-card.active {
            border-color: var(--primary-color);
            background: rgba(37, 211, 102, 0.05);
        }

        .method-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .method-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-right: 15px;
            width: 50px;
            text-align: center;
        }

        .method-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-text);
        }

        .method-description {
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .connection-area {
            background: white;
            border-radius: 8px;
            padding: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
        }

        .connection-area.active {
            border-color: var(--primary-color);
            background: rgba(37, 211, 102, 0.02);
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            display: inline-block;
        }

        .qr-code {
            width: 256px;
            height: 256px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .pairing-code {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
            letter-spacing: 8px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(37, 211, 102, 0.1);
            border-radius: 12px;
            border: 2px dashed var(--primary-color);
            display: inline-block;
        }

        .status-indicator {
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            margin: 20px 0;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .status-connecting {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }

        .status-connected {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }

        .status-waiting {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            margin-top: 30px;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 8px;
            transition: var(--transition);
        }

        .instruction-step:hover {
            background: rgba(37, 211, 102, 0.05);
        }

        .step-number {
            background: var(--primary-color);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .step-content h5 {
            color: var(--dark-text);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .step-content p {
            color: #6c757d;
            margin: 0;
            line-height: 1.6;
        }

        .bot-commands {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            margin-top: 30px;
        }

        .command-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .command-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .command-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .command-name {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .command-description {
            color: #6c757d;
            line-height: 1.5;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .alert {
            border-radius: 8px;
            border: none;
            padding: 20px;
            margin: 20px 0;
        }

        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-info {
            background: rgba(13, 202, 240, 0.1);
            color: #0dcaf0;
            border-left: 4px solid #0dcaf0;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .connection-success {
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .connection-methods {
                padding: 20px;
            }

            .method-card {
                padding: 20px;
            }

            .pairing-code {
                font-size: 2rem;
                letter-spacing: 4px;
            }

            .qr-code {
                width: 200px;
                height: 200px;
            }

            .command-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-card">
            <!-- Header -->
            <div class="header">
                <div class="whatsapp-icon">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h1>Connect to WhatsApp</h1>
                <p>Connect your EliTechWiz AI bot to WhatsApp using QR code or pairing code</p>
            </div>

            <!-- Connection Methods -->
            <div class="connection-methods">
                <div class="row">
                    <div class="col-md-6">
                        <div class="method-card" id="qr-method" onclick="selectMethod('qr')">
                            <div class="method-header">
                                <div class="method-icon">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <div>
                                    <div class="method-title">QR Code</div>
                                </div>
                            </div>
                            <div class="method-description">
                                Scan the QR code with your WhatsApp mobile app to connect instantly. This is the quickest method for most users.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="method-card" id="pairing-method" onclick="selectMethod('pairing')">
                            <div class="method-header">
                                <div class="method-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>
                                    <div class="method-title">Pairing Code</div>
                                </div>
                            </div>
                            <div class="method-description">
                                Enter an 8-digit pairing code in your WhatsApp settings. Perfect for headless servers or when QR scanning isn't possible.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connection Area -->
                <div class="connection-area" id="connection-area">
                    <div id="initial-state">
                        <i class="fas fa-link" style="font-size: 3rem; color: #6c757d; margin-bottom: 20px;"></i>
                        <h4>Select a Connection Method</h4>
                        <p class="text-muted">Choose QR Code or Pairing Code method above to start connecting your bot to WhatsApp</p>
                        <button class="btn btn-primary" onclick="startConnection()" disabled id="start-btn">
                            <i class="fas fa-play me-2"></i>Start Connection
                        </button>
                    </div>

                    <div id="qr-display" style="display: none;">
                        <h4>Scan QR Code</h4>
                        <div class="qr-code-container">
                            <canvas id="qr-code" class="qr-code"></canvas>
                        </div>
                        <div class="status-indicator status-waiting" id="qr-status">
                            <div class="spinner"></div>
                            <span>Waiting for QR code...</span>
                        </div>
                        <p class="text-muted">Open WhatsApp on your phone → Settings → Linked Devices → Link a Device → Scan this QR code</p>
                    </div>

                    <div id="pairing-display" style="display: none;">
                        <h4>Enter Pairing Code</h4>
                        <div class="pairing-code" id="pairing-code">
                            --------
                        </div>
                        <div class="status-indicator status-waiting" id="pairing-status">
                            <div class="spinner"></div>
                            <span>Generating pairing code...</span>
                        </div>
                        <p class="text-muted">Open WhatsApp → Settings → Linked Devices → Link a Device → Link with Phone Number → Enter the code above</p>
                    </div>

                    <div id="connection-success" style="display: none;">
                        <div class="connection-success">
                            <div class="success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Successfully Connected!</h3>
                            <p class="text-muted">Your EliTechWiz AI bot is now connected to WhatsApp and ready to use.</p>
                            <div class="mt-4">
                                <button class="btn btn-primary me-3" onclick="testBot()">
                                    <i class="fas fa-paper-plane me-2"></i>Test Bot
                                </button>
                                <button class="btn btn-outline-primary" onclick="showCommands()">
                                    <i class="fas fa-list me-2"></i>View Commands
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="connection-error" style="display: none;">
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 20px;"></i>
                            <h4>Connection Failed</h4>
                            <p class="text-muted" id="error-message">An error occurred while connecting to WhatsApp.</p>
                            <button class="btn btn-primary" onclick="retryConnection()">
                                <i class="fas fa-redo me-2"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Connection Status Alert -->
                <div id="status-alert" style="display: none;"></div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3><i class="fas fa-book-open me-3"></i>How to Connect</h3>
                <p class="text-muted mb-4">Follow these simple steps to connect your bot to WhatsApp:</p>

                <div id="qr-instructions" style="display: none;">
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5>Select QR Code Method</h5>
                            <p>Click on the "QR Code" option above and then click "Start Connection" to generate a QR code.</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5>Open WhatsApp on Your Phone</h5>
                            <p>Launch WhatsApp on your mobile device and go to Settings (⚙️).</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5>Access Linked Devices</h5>
                            <p>Tap on "Linked Devices" and then "Link a Device".</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h5>Scan the QR Code</h5>
                            <p>Point your phone's camera at the QR code displayed above. The connection will be established automatically.</p>
                        </div>
                    </div>
                </div>

                <div id="pairing-instructions" style="display: none;">
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5>Select Pairing Code Method</h5>
                            <p>Click on the "Pairing Code" option above and then click "Start Connection" to generate a pairing code.</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5>Open WhatsApp Settings</h5>
                            <p>Open WhatsApp on your phone and go to Settings → Linked Devices.</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5>Choose Link with Phone Number</h5>
                            <p>Tap "Link a Device" and then select "Link with Phone Number instead".</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h5>Enter the Pairing Code</h5>
                            <p>Enter the 8-digit code displayed above in your WhatsApp app to complete the connection.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot Commands -->
            <div class="bot-commands">
                <h3><i class="fas fa-robot me-3"></i>Bot Commands & Usage</h3>
                <p class="text-muted mb-4">Once connected, you can use these commands to interact with your EliTechWiz AI bot:</p>

                <div class="command-grid">
                    <div class="command-card">
                        <div class="command-name">/start</div>
                        <div class="command-description">Activate the bot in the current chat. The bot will start responding to messages in this conversation.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/stop</div>
                        <div class="command-description">Deactivate the bot in the current chat. The bot will stop responding to messages.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/help</div>
                        <div class="command-description">Display a list of all available commands and their descriptions.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/about</div>
                        <div class="command-description">Get information about the bot, including the AI model being used and version details.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/status</div>
                        <div class="command-description">Check the current status of the bot, including active chats and AI service connectivity.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/clear</div>
                        <div class="command-description">Clear the conversation context and start fresh with the AI assistant.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/ping</div>
                        <div class="command-description">Test if the bot is responsive and online.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/config</div>
                        <div class="command-description">View current bot configuration (requires owner privileges).</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/setmodel [provider] [model]</div>
                        <div class="command-description">Change the AI model being used. Example: /setmodel openai gpt-4o</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/setmode [private|public]</div>
                        <div class="command-description">Set bot mode to private (only activated chats) or public (all chats).</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/models [provider]</div>
                        <div class="command-description">List available AI models for a specific provider.</div>
                    </div>
                    <div class="command-card">
                        <div class="command-name">/providers</div>
                        <div class="command-description">List all available AI providers and their API key status.</div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <h5><i class="fas fa-info-circle me-2"></i>Getting Started</h5>
                    <p class="mb-2">After connecting your bot:</p>
                    <ol class="mb-0">
                        <li>Send <code>/start</code> in any chat to activate the bot</li>
                        <li>Start chatting! The bot will respond to your messages using AI</li>
                        <li>Use <code>/help</code> anytime to see all available commands</li>
                        <li>Configure the bot using <code>/config</code> commands (owner only)</li>
                    </ol>
                </div>

                <div class="alert alert-warning mt-3">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h5>
                    <ul class="mb-0">
                        <li>The bot requires an active internet connection to function</li>
                        <li>AI responses depend on the configured API keys and models</li>
                        <li>Configuration commands require owner privileges or admin passcode</li>
                        <li>The bot will remember conversation context for better responses</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h4>Connecting to WhatsApp...</h4>
            <p class="text-muted">Please wait while we establish the connection.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let selectedMethod = null;
        let socket = null;
        let connectionStatus = 'disconnected';
        let retryCount = 0;
        const maxRetries = 3;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            checkConnectionStatus();
        });

        // Initialize WebSocket connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
                showStatusAlert('Connected to server', 'success');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                showStatusAlert('Disconnected from server', 'warning');
            });

            socket.on('qr-code', function(data) {
                console.log('QR code received');
                displayQRCode(data.qr);
                updateStatus('qr', 'waiting', 'Scan the QR code with WhatsApp');
            });

            socket.on('pairing-code', function(data) {
                console.log('Pairing code received:', data.code);
                displayPairingCode(data.code);
                updateStatus('pairing', 'waiting', 'Enter the code in WhatsApp');
            });

            socket.on('connection-update', function(data) {
                console.log('Connection update:', data);
                handleConnectionUpdate(data);
            });

            socket.on('connection-success', function(data) {
                console.log('Connection successful:', data);
                showConnectionSuccess();
                connectionStatus = 'connected';
            });

            socket.on('connection-error', function(data) {
                console.log('Connection error:', data);
                showConnectionError(data.error || 'Unknown error occurred');
                connectionStatus = 'error';
            });

            socket.on('bot-status', function(data) {
                console.log('Bot status:', data);
                updateBotStatus(data);
            });
        }

        // Select connection method
        function selectMethod(method) {
            selectedMethod = method;
            
            // Update UI
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(method + '-method').classList.add('active');
            
            // Enable start button
            document.getElementById('start-btn').disabled = false;
            
            // Show relevant instructions
            document.getElementById('qr-instructions').style.display = method === 'qr' ? 'block' : 'none';
            document.getElementById('pairing-instructions').style.display = method === 'pairing' ? 'block' : 'none';
            
            // Update connection area
            document.getElementById('connection-area').classList.add('active');
        }

        // Start connection process
        function startConnection() {
            if (!selectedMethod) {
                showStatusAlert('Please select a connection method first', 'warning');
                return;
            }

            // Show loading
            showLoading(true);
            
            // Hide initial state
            document.getElementById('initial-state').style.display = 'none';
            
            // Show appropriate display
            if (selectedMethod === 'qr') {
                document.getElementById('qr-display').style.display = 'block';
                updateStatus('qr', 'connecting', 'Generating QR code...');
            } else {
                document.getElementById('pairing-display').style.display = 'block';
                updateStatus('pairing', 'connecting', 'Generating pairing code...');
            }

            // Request connection from server
            socket.emit('start-connection', { method: selectedMethod });
            
            // Hide loading after a short delay
            setTimeout(() => showLoading(false), 2000);
        }

        // Display QR code
        function displayQRCode(qrData) {
            const canvas = document.getElementById('qr-code');
            QRCode.toCanvas(canvas, qrData, {
                width: 256,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('QR code generation error:', error);
                    showConnectionError('Failed to generate QR code');
                } else {
                    console.log('QR code generated successfully');
                }
            });
        }

        // Display pairing code
        function displayPairingCode(code) {
            document.getElementById('pairing-code').textContent = code;
        }

        // Update status indicator
        function updateStatus(method, status, message) {
            const statusElement = document.getElementById(method + '-status');
            const spinner = statusElement.querySelector('.spinner');
            const textElement = statusElement.querySelector('span');
            
            // Remove all status classes
            statusElement.classList.remove('status-connecting', 'status-connected', 'status-error', 'status-waiting');
            
            // Add appropriate status class
            statusElement.classList.add('status-' + status);
            
            // Update text
            textElement.textContent = message;
            
            // Show/hide spinner
            if (status === 'connecting' || status === 'waiting') {
                spinner.style.display = 'block';
            } else {
                spinner.style.display = 'none';
            }
        }

        // Handle connection updates
        function handleConnectionUpdate(data) {
            const { connection, lastDisconnect } = data;
            
            if (connection === 'connecting') {
                if (selectedMethod) {
                    updateStatus(selectedMethod, 'connecting', 'Connecting to WhatsApp...');
                }
                showStatusAlert('Connecting to WhatsApp...', 'info');
            } else if (connection === 'open') {
                showConnectionSuccess();
                showStatusAlert('Successfully connected to WhatsApp!', 'success');
                connectionStatus = 'connected';
            } else if (connection === 'close') {
                const shouldReconnect = lastDisconnect && lastDisconnect.shouldReconnect;
                if (shouldReconnect) {
                    showStatusAlert('Connection lost. Attempting to reconnect...', 'warning');
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(() => {
                            socket.emit('start-connection', { method: selectedMethod });
                        }, 5000);
                    } else {
                        showConnectionError('Failed to reconnect after multiple attempts');
                    }
                } else {
                    showConnectionError('Connection closed. Please restart the connection process.');
                }
            }
        }

        // Show connection success
        function showConnectionSuccess() {
            // Hide other displays
            document.getElementById('qr-display').style.display = 'none';
            document.getElementById('pairing-display').style.display = 'none';
            document.getElementById('connection-error').style.display = 'none';
            
            // Show success
            document.getElementById('connection-success').style.display = 'block';
            document.getElementById('connection-success').classList.add('fade-in');
            
            // Play success sound (if available)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.play().catch(() => {});
            } catch (e) {}
        }

        // Show connection error
        function showConnectionError(errorMessage) {
            // Hide other displays
            document.getElementById('qr-display').style.display = 'none';
            document.getElementById('pairing-display').style.display = 'none';
            document.getElementById('connection-success').style.display = 'none';
            
            // Show error
            document.getElementById('connection-error').style.display = 'block';
            document.getElementById('error-message').textContent = errorMessage;
            
            showStatusAlert('Connection failed: ' + errorMessage, 'danger');
        }

        // Retry connection
        function retryConnection() {
            retryCount = 0;
            document.getElementById('connection-error').style.display = 'none';
            startConnection();
        }

        // Test bot functionality
        function testBot() {
            showStatusAlert('To test the bot, send a message to your WhatsApp number or use the /ping command', 'info');
        }

        // Show commands section
        function showCommands() {
            document.querySelector('.bot-commands').scrollIntoView({ behavior: 'smooth' });
        }

        // Show status alert
        function showStatusAlert(message, type) {
            const alertElement = document.getElementById('status-alert');
            alertElement.className = `alert alert-${type} fade-in`;
            alertElement.innerHTML = `
                <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                ${message}
            `;
            alertElement.style.display = 'block';
            
            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'danger') {
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }

        // Get alert icon based on type
        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'warning': return 'exclamation-triangle';
                case 'danger': return 'times-circle';
                case 'info': return 'info-circle';
                default: return 'info-circle';
            }
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // Check initial connection status
        function checkConnectionStatus() {
            socket.emit('check-status');
        }

        // Update bot status
        function updateBotStatus(status) {
            if (status.connected) {
                showConnectionSuccess();
                connectionStatus = 'connected';
            }
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && socket) {
                socket.emit('check-status');
            }
        });

        // Handle window beforeunload
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
